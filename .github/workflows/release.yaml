name: Release

on:
  push:
    tags: ['*-v*.*']  # Match tags like 'TheBackyard.MonogameLib v1.2.3'
  workflow_dispatch:
    inputs:
      project:
        description: 'Project/package to publish (e.g., TheBackyard.MonogameLib)'
        required: true
      version:
        description: 'Version to publish (e.g., 1.2.3)'
        required: true

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            8.0.x

      - name: Parse tag or inputs
        id: meta
        shell: pwsh
        run: |
          $ref = "${{ github.ref_name }}"
          $project = "${{ github.event.inputs.project }}"
          $version = "${{ github.event.inputs.version }}"
          if ($ref -match '^(?<proj>.+)[ -]v(?<ver>\d+\.\d+\.\d+(?:\.\d+)*)$') {
            $proj = "TheBackyard." + $Matches['proj'].Trim()
            $ver = $Matches['ver'].Trim()
          } elseif ($project -and $version) {
            $proj = "TheBackyard." + $project.Trim()
            $ver = $version.Trim()
          } else {
            throw "Tag must be in format '<ShortProject> v<version>' or provide both project and version as workflow inputs."
          }
          "project=$proj" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Find project file
        id: findproj
        shell: pwsh
        run: |
          $proj = "${{ steps.meta.outputs.project }}"
          $csproj = Get-ChildItem -Recurse -Filter "$proj.csproj" | Select-Object -First 1
          if (-not $csproj) { throw "Could not find project file for $proj" }
          "csproj=$($csproj.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Restore, build, pack
        shell: pwsh
        run: |
          $csproj = "${{ steps.findproj.outputs.csproj }}"
          $out = ".\artifacts\packages"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $ver = "${{ steps.meta.outputs.version }}"
          dotnet restore "$csproj"
          dotnet build "$csproj" -c Release --no-restore
          dotnet pack "$csproj" -c Release -o $out --no-build -p:Version=$ver

      - name: Push package to nuget.org
        shell: pwsh
        run: |
          $src = "https://api.nuget.org/v3/index.json"
          $key = "${{ secrets.NUGET_API_KEY }}"
          $pkg = Get-ChildItem ".\artifacts\packages\*.nupkg" | Select-Object -First 1
          if ($pkg) {
            dotnet nuget push $pkg.FullName --source $src --api-key $key --skip-duplicate
          } else {
            throw "No package found to push."
          }

        - name: Create GitHub Release (filtered by commit prefix)
          shell: pwsh
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            $tag = "${{ github.ref_name }}"
            if ($tag -notmatch '^(.+)-v(.+)$') {
              throw "Tag does not match <Lib>-v<version>"
            }

            $lib = $matches[1]
            $version = $matches[2]

            # Find previous tag for this library
            $prevTag = git tag --list "$lib-v*" --sort=-version:refname |
                      Where-Object { $_ -ne $tag } |
                      Select-Object -First 1

            if (-not $prevTag) {
              $range = $tag
            } else {
              $range = "$prevTag..$tag"
            }

            # Collect matching commits
            $commits = git log $range --pretty=format:"- %s" |
                      Where-Object { $_ -like "$lib:*" } |
                      ForEach-Object { $_.Substring($lib.Length + 2) }

            if (-not $commits) {
              $commits = "- No user-facing changes"
            }

            $notes = @"
        **NuGet package**
        https://www.nuget.org/packages/$lib/$version

        ---

        ### Changes in $lib
        $($commits -join "`n")
        "@

            gh release create "$tag" `
              --title "$tag" `
              --notes "$notes"